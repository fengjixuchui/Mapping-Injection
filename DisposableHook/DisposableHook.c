#include "stdio.h"
#include "Windows.h"

typedef struct _OBJECT_ATTRIBUTES {
	ULONG           Length;
	HANDLE          RootDirectory;
	PVOID			ObjectName;
	ULONG           Attributes;
	PVOID           SecurityDescriptor;
	PVOID           SecurityQualityOfService;
} OBJECT_ATTRIBUTES, * POBJECT_ATTRIBUTES;

typedef NTSTATUS(NTAPI* pNtCreateThreadEx)(PHANDLE hThread, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, HANDLE ProcessHandle, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, BOOL CreateSuspended, ULONG StackZeroBits, ULONG SizeOfStackCommit, ULONG SizeOfStackReserve, LPVOID lpBytesBuffer);
pNtCreateThreadEx NtCreateThreadEx;

void DisposableHook(LPVOID shellcodeAddr, char* threadCreated);
DWORD WINAPI SampleFunction(LPVOID lpParam);

#pragma section(".text")
__declspec(allocate(".text"))
// source: NtCreateThreadEx.asm
char NtCreateThreadExCode[] = { 0x65,0x67,0x48,0xa1,0x60,0x00,0x00,0x00,0x81,0xb8,0x20,0x01,0x00,0x00,0x00,0x28,0x00,0x00,0x74,0x64,0x81,0xb8,0x20,0x01,0x00,0x00,0x5a,0x29,0x00,0x00,0x74,0x5f,0x81,0xb8,0x20,0x01,0x00,0x00,0x39,0x38,0x00,0x00,0x74,0x5a,0x81,0xb8,0x20,0x01,0x00,0x00,0xd7,0x3a,0x00,0x00,0x74,0x55,0x81,0xb8,0x20,0x01,0x00,0x00,0xab,0x3f,0x00,0x00,0x74,0x50,0x81,0xb8,0x20,0x01,0x00,0x00,0xee,0x42,0x00,0x00,0x74,0x4b,0x81,0xb8,0x20,0x01,0x00,0x00,0x63,0x45,0x00,0x00,0x74,0x46,0x81,0xb8,0x20,0x01,0x00,0x00,0xba,0x47,0x00,0x00,0x74,0x41,0x81,0xb8,0x20,0x01,0x00,0x00,0xbb,0x47,0x00,0x00,0x74,0x3c,0x7f,0x41,0xeb,0x46,0xb8,0xb3,0x00,0x00,0x00,0xeb,0x44,0xb8,0xb4,0x00,0x00,0x00,0xeb,0x3d,0xb8,0xb6,0x00,0x00,0x00,0xeb,0x36,0xb8,0xb9,0x00,0x00,0x00,0xeb,0x2f,0xb8,0xba,0x00,0x00,0x00,0xeb,0x28,0xb8,0xbb,0x00,0x00,0x00,0xeb,0x21,0xb8,0xbc,0x00,0x00,0x00,0xeb,0x1a,0xb8,0xbd,0x00,0x00,0x00,0xeb,0x13,0xb8,0xbd,0x00,0x00,0x00,0xeb,0x0c,0xb8,0xc1,0x00,0x00,0x00,0xeb,0x05,0xb8,0xff,0xff,0xff,0xff,0x49,0x89,0xca,0x0f,0x05,0xc3 };

int main()
{
	//NtSetInformationProcess = (pNtSetInformationProcess)GetProcAddress(GetModuleHandle(L"ntdll"), "NtSetInformationProcess");
	NtCreateThreadEx = (pNtCreateThreadEx)&NtCreateThreadExCode;
	char threadCreated = 0x00;
	printf("DisposableHook Start!\n");
	DisposableHook((LPVOID)&SampleFunction, &threadCreated);
	printf("DisposableHook End!\n");
	Sleep(3000);
	return 0;
}

void DisposableHook(LPVOID shellcodeAddr, char *threadCreated) {
	NTSTATUS status;
	HANDLE tHandle = NULL;
	OBJECT_ATTRIBUTES objAttr = { sizeof(objAttr) };

	*threadCreated = 1;		//avoid recursion
	status = NtCreateThreadEx(&tHandle, GENERIC_EXECUTE, &objAttr, (HANDLE)-1, (LPVOID)shellcodeAddr, NULL, FALSE, 0, 0, 0, NULL);
	if (status != 0) 
		*threadCreated = 0; //thread creation failed, reset flag
}

DWORD WINAPI SampleFunction(LPVOID lpParam)
{
	printf("thread start\n");
	WinExec("C:\\Windows\\System32\\cmd.exe /c ping -n 3 127.0.0.1", 1);
	Sleep(3000);
	printf("thread end\n");
	return 0;
}